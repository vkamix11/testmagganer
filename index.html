<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chat</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#0a1929;height:100vh;overflow:hidden}
        .app-container{height:100vh;display:flex;flex-direction:column}
        .header{background:#1a2332;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #2d3748}
        .logo{font-size:24px;font-weight:700;color:#0084ff;display:flex;align-items:center;gap:8px}
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .setup-screen{flex:1;display:flex;align-items:center;justify-content:center;padding:20px}
        .setup-card{background:#1a2332;border-radius:16px;padding:40px;max-width:480px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.4)}
        .setup-title{color:#fff;font-size:28px;font-weight:600;margin-bottom:32px;text-align:center}
        .input-wrapper{margin-bottom:24px}
        .input-wrapper input{width:100%;padding:16px;background:#0a1929;border:2px solid #2d3748;border-radius:12px;font-size:16px;color:#fff;transition:.2s}
        .input-wrapper input:focus{outline:none;border-color:#0084ff;background:#0f1e2e}
        .input-wrapper input::placeholder{color:#6b7280}
        .button-row{display:flex;gap:12px}
        .btn{flex:1;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:#0084ff;color:#fff}
        .btn-primary:hover:not(:disabled){background:#0073e6;transform:translateY(-1px)}
        .btn-secondary{background:#2d3748;color:#fff}
        .btn-secondary:hover:not(:disabled){background:#374151}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .call-screen{flex:1;display:none;position:relative;background:#000}
        .call-screen.active{display:block}
        .video-main{position:absolute;inset:0}
        .video-container{width:100%;height:100%;position:relative;cursor:pointer}
        video{width:100%;height:100%;object-fit:cover}
        .video-label{position:absolute;top:16px;left:16px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);color:#fff;padding:8px 16px;border-radius:20px;font-size:14px;z-index:5}
        .video-pip{position:absolute;top:20px;right:20px;width:240px;height:180px;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.5);border:2px solid #2d3748;z-index:10}
        .controls-bar{position:absolute;bottom:120px;left:50%;transform:translateX(-50%);display:flex;gap:16px;z-index:20;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);padding:16px 24px;border-radius:48px}
        .control-btn{width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;background:rgba(255,255,255,.15);color:#fff;transition:.2s}
        .control-btn:hover{background:rgba(255,255,255,.25);transform:scale(1.05)}
        .control-btn.active{background:rgba(239,68,68,.9)}
        .control-btn.end-call{background:#ef4444;width:64px;height:64px}
        .control-btn.end-call:hover{background:#dc2626}
        .settings-modal{position:absolute;bottom:200px;left:50%;transform:translateX(-50%);background:#1a2332;border-radius:16px;padding:24px;width:90%;max-width:400px;display:none;z-index:100}
        .settings-modal.show{display:block}
        .status-bar{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:#fff;padding:12px 24px;border-radius:24px;z-index:15;display:none}
        .status-bar.show{display:block}
    </style>
</head>
<body>
<div class="app-container">
<div class="header"><div class="logo">Video Chat</div></div>
<div class="main-content">
<div class="setup-screen" id="setupScreen">
<div class="setup-card">
<h1 class="setup-title">Rozpocznij rozmowƒô</h1>
<div class="input-wrapper"><input id="roomId" placeholder="Wpisz ID pokoju"></div>
<div class="button-row">
<button id="startBtn" class="btn btn-primary">Utw√≥rz</button>
<button id="joinBtn" class="btn btn-secondary">Do≈ÇƒÖcz</button>
</div>
</div>
</div>

<div class="call-screen" id="callScreen">
<div class="video-main" id="videoMain">
<div class="video-container" id="remoteContainer">
<video id="remoteVideo" autoplay playsinline></video>
</div>
</div>
<div class="video-pip">
<div class="video-container" id="localContainer">
<video id="localVideo" autoplay muted playsinline></video>
</div>
</div>
<div class="status-bar" id="statusBar"></div>
<div class="controls-bar">
<button class="control-btn" id="toggleMicBtn">üé§</button>
<button class="control-btn" id="toggleCamBtn">üìπ</button>
<button class="control-btn end-call" id="endCallBtn">‚úñÔ∏è</button>
</div>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<script>
let peer=null,currentCall=null;
let rawStream=null,processedStream=null;
let audioContext=null;
let statsInterval=null;

const localVideo=document.getElementById('localVideo');
const remoteVideo=document.getElementById('remoteVideo');
const startBtn=document.getElementById('startBtn');
const joinBtn=document.getElementById('joinBtn');
const roomIdInput=document.getElementById('roomId');
const setupScreen=document.getElementById('setupScreen');
const callScreen=document.getElementById('callScreen');
const statusBar=document.getElementById('statusBar');
const toggleMicBtn=document.getElementById('toggleMicBtn');
const toggleCamBtn=document.getElementById('toggleCamBtn');
const endCallBtn=document.getElementById('endCallBtn');

function showStatus(t){statusBar.textContent=t;statusBar.classList.add('show')}

async function getMedia(){
rawStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
audioContext=new (window.AudioContext||window.webkitAudioContext)();
await audioContext.resume();
const src=audioContext.createMediaStreamSource(rawStream);
const dest=audioContext.createMediaStreamDestination();
src.connect(dest);
processedStream=new MediaStream([rawStream.getVideoTracks()[0],dest.stream.getAudioTracks()[0]]);
return {rawStream,processedStream};
}

function createPeer(id){return new Peer(id,{host:'0.peerjs.com',secure:true,port:443})}

startBtn.onclick=async()=>{
const id=roomIdInput.value.trim();if(!id)return;
showStatus('Kamera...');
const s=await getMedia();
localVideo.srcObject=s.rawStream;
setupScreen.style.display='none';callScreen.classList.add('active');
peer=createPeer(id);
peer.on('call',call=>{
currentCall=call;
call.answer(s.processedStream);
call.on('stream',r=>{
remoteVideo.srcObject=r;
statsInterval=setInterval(()=>{},2000);
});
});
};

joinBtn.onclick=async()=>{
const id=roomIdInput.value.trim();if(!id)return;
showStatus('Kamera...');
const s=await getMedia();
localVideo.srcObject=s.rawStream;
setupScreen.style.display='none';callScreen.classList.add('active');
peer=createPeer();
peer.on('open',()=>{
const call=peer.call(id,s.processedStream);
currentCall=call;
call.on('stream',r=>{
remoteVideo.srcObject=r;
statsInterval=setInterval(()=>{},2000);
});
});
};

toggleMicBtn.onclick=()=>{
rawStream?.getAudioTracks().forEach(t=>t.enabled=!t.enabled);
processedStream?.getAudioTracks().forEach(t=>t.enabled=!t.enabled);
};

toggleCamBtn.onclick=()=>{
rawStream?.getVideoTracks().forEach(t=>t.enabled=!t.enabled);
processedStream?.getVideoTracks().forEach(t=>t.enabled=!t.enabled);
};

endCallBtn.onclick=()=>{
currentCall?.close();
peer?.destroy();
rawStream?.getTracks().forEach(t=>t.stop());
processedStream?.getTracks().forEach(t=>t.stop());
audioContext?.close();
if(statsInterval){clearInterval(statsInterval);statsInterval=null}
location.reload();
};
</script>
</body>
</html>
