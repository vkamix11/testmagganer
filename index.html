<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC Video Chat</title>

<style>
/* =========================
   RESET / BASE
========================= */
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
background:#0a1929;
color:#fff;
overflow:hidden
}

/* =========================
   LAYOUT
========================= */
.app{height:100%;display:flex;flex-direction:column}
.header{
height:64px;
background:#1a2332;
display:flex;
align-items:center;
padding:0 24px;
border-bottom:1px solid #2d3748
}
.logo{
display:flex;
align-items:center;
gap:10px;
font-weight:700;
font-size:22px;
color:#0084ff
}

.main{flex:1;position:relative}

/* =========================
   SETUP SCREEN
========================= */
.setup{
position:absolute;
inset:0;
display:flex;
align-items:center;
justify-content:center
}
.setup-card{
background:#1a2332;
padding:40px;
border-radius:18px;
width:100%;
max-width:480px;
box-shadow:0 10px 40px rgba(0,0,0,.5)
}
.setup-title{
text-align:center;
font-size:28px;
margin-bottom:32px
}
.input{
width:100%;
padding:16px;
border-radius:12px;
border:2px solid #2d3748;
background:#0a1929;
color:#fff;
font-size:16px
}
.input:focus{outline:none;border-color:#0084ff}
.buttons{
margin-top:24px;
display:flex;
gap:12px
}
.btn{
flex:1;
padding:16px;
border:none;
border-radius:12px;
font-size:16px;
font-weight:600;
cursor:pointer
}
.btn.primary{background:#0084ff;color:#fff}
.btn.secondary{background:#2d3748;color:#fff}
.btn.primary:hover{background:#0073e6}
.btn.secondary:hover{background:#374151}

/* =========================
   CALL SCREEN
========================= */
.call{position:absolute;inset:0;display:none;background:#000}
.call.active{display:block}
.video-main{position:absolute;inset:0}
.video-box{position:relative;width:100%;height:100%;background:#000}
video{width:100%;height:100%;object-fit:cover}

.label{
position:absolute;
top:16px;
left:16px;
background:rgba(0,0,0,.6);
padding:6px 14px;
border-radius:20px;
font-size:14px
}

.pip{
position:absolute;
top:16px;
right:16px;
width:220px;
height:160px;
border-radius:12px;
overflow:hidden;
border:2px solid #2d3748;
z-index:5;
cursor:pointer
}

/* =========================
   CONTROLS
========================= */
.controls{
position:absolute;
bottom:90px;
left:50%;
transform:translateX(-50%);
display:flex;
gap:16px;
background:rgba(0,0,0,.6);
padding:14px 22px;
border-radius:40px;
backdrop-filter:blur(10px)
}
.ctrl{
width:56px;
height:56px;
border-radius:50%;
border:none;
font-size:22px;
cursor:pointer;
background:rgba(255,255,255,.15);
color:#fff
}
.ctrl:hover{background:rgba(255,255,255,.25)}
.ctrl.active{background:#ef4444}
.ctrl.end{background:#ef4444;width:64px;height:64px}

/* =========================
   STATUS
========================= */
.status{
position:absolute;
top:20px;
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,.7);
padding:10px 22px;
border-radius:24px;
font-size:14px;
display:none;
z-index:10
}
.status.show{display:block}
.status.ok{background:rgba(34,197,94,.9)}
.status.warn{background:rgba(251,191,36,.9);color:#000}

/* =========================
   CAMERA OFF
========================= */
.cam-off{
position:absolute;
inset:0;
display:none;
align-items:center;
justify-content:center;
flex-direction:column;
background:#111;
z-index:3
}
.cam-off.show{display:flex}
.cam-off span{font-size:64px;margin-bottom:10px;opacity:.6}

/* =========================
   SETTINGS
========================= */
.settings{
position:absolute;
bottom:180px;
left:50%;
transform:translateX(-50%);
width:90%;
max-width:420px;
background:#1a2332;
border-radius:16px;
padding:24px;
display:none;
z-index:20
}
.settings.show{display:block}
.settings h3{margin-bottom:20px}
.group{margin-bottom:18px}
.group label{font-size:14px;color:#9ca3af}
select{
width:100%;
margin-top:6px;
padding:12px;
border-radius:8px;
background:#0a1929;
border:2px solid #2d3748;
color:#fff
}
</style>
</head>

<body>
<div class="app">

<div class="header">
<div class="logo">üé• WebRTC Chat</div>
</div>

<div class="main">

<div class="setup" id="setup">
<div class="setup-card">
<div class="setup-title">Po≈ÇƒÖcz siƒô</div>
<input id="roomInput" class="input" placeholder="ID pokoju">
<div class="buttons">
<button id="createBtn" class="btn primary">Utw√≥rz</button>
<button id="joinBtn" class="btn secondary">Do≈ÇƒÖcz</button>
</div>
</div>
</div>

<div class="call" id="call">
<div class="video-main" id="videoMain">
<div class="video-box" id="remoteBox">
<video id="remoteVideo" autoplay playsinline></video>
<div class="label">Rozm√≥wca</div>
<div class="cam-off" id="remoteOff">
<span>üì∑</span>
Kamera wy≈ÇƒÖczona
</div>
</div>
</div>

<div class="pip" id="pip">
<div class="video-box" id="localBox">
<video id="localVideo" autoplay muted playsinline></video>
<div class="label">Ty</div>
<div class="cam-off" id="localOff"><span>üì∑</span></div>
</div>
</div>

<div class="status" id="status"></div>

<div class="controls">
<button id="micBtn" class="ctrl">üé§</button>
<button id="camBtn" class="ctrl">üìπ</button>
<button id="swapBtn" class="ctrl">üîÑ</button>
<button id="settingsBtn" class="ctrl">‚öôÔ∏è</button>
<button id="endBtn" class="ctrl end">‚úñ</button>
</div>

<div class="settings" id="settings">
<h3>Ustawienia</h3>
<div class="group">
<label>Jako≈õƒá wideo</label>
<select id="quality">
<option value="auto">Auto</option>
<option value="1080p">1080p</option>
<option value="720p">720p</option>
<option value="480p">480p</option>
</select>
</div>
<div class="group">
<label>FPS</label>
<select id="fps">
<option value="auto">Auto</option>
<option value="60">60</option>
<option value="30">30</option>
<option value="15">15</option>
</select>
</div>
<div class="group">
<label>Bitrate</label>
<select id="bitrate">
<option value="auto">Auto</option>
<option value="2500">2.5 Mbps</option>
<option value="1500">1.5 Mbps</option>
<option value="800">800 Kbps</option>
</select>
</div>
</div>

</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<script>
let peer=null,call=null,dataConn=null;
let rawStream=null,processedStream=null;
let audioCtx=null;
let mic=true,cam=true,localMain=false;
let statsTimer=null;

const setup=document.getElementById("setup");
const callUI=document.getElementById("call");
const status=document.getElementById("status");
const roomInput=document.getElementById("roomInput");
const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");
const localOff=document.getElementById("localOff");
const remoteOff=document.getElementById("remoteOff");
const videoMain=document.getElementById("videoMain");
const pip=document.getElementById("pip");
const settings=document.getElementById("settings");

function showStatus(msg,type){
status.textContent=msg;
status.className="status show "+(type||"");
setTimeout(()=>status.classList.remove("show"),3000);
}

async function getStream(){
const constraints={video:true,audio:{echoCancellation:true,noiseSuppression:true}};
rawStream=await navigator.mediaDevices.getUserMedia(constraints);
audioCtx=new AudioContext();
await audioCtx.resume();
const src=audioCtx.createMediaStreamSource(rawStream);
const comp=audioCtx.createDynamicsCompressor();
src.connect(comp);
const dest=audioCtx.createMediaStreamDestination();
comp.connect(dest);
processedStream=new MediaStream([
rawStream.getVideoTracks()[0],
dest.stream.getAudioTracks()[0]
]);
return rawStream;
}

function createPeer(id){
return new Peer(id,{
host:"0.peerjs.com",
port:443,
secure:true,
config:{
iceServers:[
{urls:"stun:stun.l.google.com:19302"},
{urls:"turn:openrelay.metered.ca:443",username:"openrelayproject",credential:"openrelayproject"}
]
}
});
}

function swap(){
localMain=!localMain;
videoMain.innerHTML="";
pip.innerHTML="";
if(localMain){
videoMain.appendChild(localBox);
pip.appendChild(remoteBox);
}else{
videoMain.appendChild(remoteBox);
pip.appendChild(localBox);
}
}

document.getElementById("swapBtn").onclick=swap;

document.getElementById("micBtn").onclick=()=>{
mic=!mic;
rawStream.getAudioTracks().forEach(t=>t.enabled=mic);
processedStream.getAudioTracks().forEach(t=>t.enabled=mic);
};

document.getElementById("camBtn").onclick=()=>{
cam=!cam;
rawStream.getVideoTracks().forEach(t=>t.enabled=cam);
processedStream.getVideoTracks().forEach(t=>t.enabled=cam);
localOff.classList.toggle("show",!cam);
if(dataConn)dataConn.send({type:"cam",on:cam});
};

document.getElementById("settingsBtn").onclick=()=>{
settings.classList.toggle("show");
};

document.getElementById("endBtn").onclick=endCall;

function endCall(){
if(call)call.close();
if(peer)peer.destroy();
if(rawStream)rawStream.getTracks().forEach(t=>t.stop());
if(audioCtx)audioCtx.close();
clearInterval(statsTimer);
setup.style.display="flex";
callUI.classList.remove("active");
}

document.getElementById("createBtn").onclick=async()=>{
if(!roomInput.value)return;
await getStream();
localVideo.srcObject=rawStream;
setup.style.display="none";
callUI.classList.add("active");
peer=createPeer(roomInput.value);
peer.on("call",c=>{
call=c;
c.answer(processedStream);
c.on("stream",s=>remoteVideo.srcObject=s);
});
peer.on("connection",c=>{
dataConn=c;
c.on("data",d=>{
if(d.type==="cam")remoteOff.classList.toggle("show",!d.on);
});
});
};

document.getElementById("joinBtn").onclick=async()=>{
if(!roomInput.value)return;
await getStream();
localVideo.srcObject=rawStream;
setup.style.display="none";
callUI.classList.add("active");
peer=createPeer();
peer.on("open",()=>{
dataConn=peer.connect(roomInput.value);
call=peer.call(roomInput.value,processedStream);
call.on("stream",s=>remoteVideo.srcObject=s);
});
};
</script>
</body>
</html>
